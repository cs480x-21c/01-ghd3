<!DOCTYPE html>

<html>
  <body>
    <p id='label' style="font-size:50px">Stars in Flag</p>
    <div id="wrapper">
      <svg id="buttons"></svg>
      <svg id="workspace"></svg>
    </div>
  </body>
</html>

<script src="https://d3js.org/d3.v6.min.js"></script>

<script>
  console.log(d3); // test if d3 is loaded

  const WIDTH = 1500;
  const HEIGHT = 910;
  const STAR = [0,6, 24,6, 4.5,15, 12,0, 19.5,15]
  const BIG_STAR = [...STAR]

  for (i = 0; i < BIG_STAR.length; i++) {
    BIG_STAR[i] *= 3;
  }

  document.getElementById("workspace").style.backgroundColor="#ffffff";
  let svg = d3.select('#workspace')
    .attr('width',WIDTH)
    .attr('height',HEIGHT)

  // Add Lines
  svg.append('line')
          .attr('x1', 100)    // endpoints
          .attr('y1', 150)
          .attr('x2', 340)
          .attr('y2', 150)
          .attr('stroke', 'red');

  let buttons = d3.select("#buttons")
    .attr('width', 300)
    .attr('height', 80)
  // Add Circles
  buttons.append('circle')
    .attr('cx', 40)    // center of circle
    .attr('cy', 40)
    .attr('r', 30)
    .attr('fill', 'red')
    .on('click', function(){
      removeChildren(document.getElementById("workspace"))
      setFlag();});
  buttons.append('circle')
    .attr('cx', 120)    // center of circle
    .attr('cy', 40)
    .attr('r', 30)
    .attr('fill', 'blue')
    .on('click', function(){
      removeChildren(document.getElementById("workspace"))
      setSky();
    });

  function removeChildren(node) {
    while (node.hasChildNodes()) {
      node.removeChild(node.childNodes[0])
    }
  }

  function arrToPoints(arr) {
    let arrStr = ''
    arr.forEach(function(item, index, array) {
      arrStr += item
      if (index % 2 == 0) {
        arrStr += ','
      }
      else {
        arrStr += ' '
      }
    })
    return arrStr;
  }

  function setFlag() {
    const BLUE_WIDTH = 597
    const BLUE_HEIGHT = 490

    setLabel("Stars in Flag")

    // Add rectangles
    for (i=0; i < 7; i++) {    // stripes
      svg.append('rect')
              .attr('x', 0)  // top left corner
              .attr('y', i*140)  // x,y coords from origin top left
              .attr('width', WIDTH)
              .attr('height', 70)
              .attr('fill', '#BF0A30');
    }
    svg.append('rect')    // blue
            .attr('x', 0)
            .attr('y', 0)
            .attr('width', BLUE_WIDTH)
            .attr('height', BLUE_HEIGHT)
            .attr('fill', '#002868');

    function changeStarXOrYBy(arr, startIndex, endIndex, start, increment, factor) {
      for (xpt = startIndex; xpt < endIndex; xpt += 2) {
        arr[xpt] += start + increment * factor;
      }
      return arr
    }

    // 56 px height
    // .o63 = 31
    // Add polygons
    for (i =0; i < 5; i++) {
      for (j = 0; j < 6; j++) {
        currPts = [...BIG_STAR];
        currPts = changeStarXOrYBy(currPts, 0, 9, 10, 100, j)
        currPts = changeStarXOrYBy(currPts, 1, 10, 20, 100, i)
        svg.append('polygon')
                .attr('points', arrToPoints(currPts))
                .style('fill', 'white')
      }
      if (i < 4) {
        for (j = 0; j < 5; j++) {
          currPts = [...BIG_STAR];
          currPts = changeStarXOrYBy(currPts, 1, 10, 70, 100, i)
          currPts = changeStarXOrYBy(currPts, 0, 9, 60, 100, j)
          svg.append('polygon')
                  .attr('points', arrToPoints(currPts))
                  .style('fill', 'white')
        }
      }
    }
  }

  function setLabel(text) {
    let label = document.getElementById("label")
    label.removeChild(label.firstChild)
    label.appendChild(document.createTextNode(text))
  }

  function addToLabel(text) {
    let label = document.getElementById("label")
    label.appendChild(document.createElement("br"))
    label.appendChild(document.createTextNode(text))
  }

  // todo: you should do this with d3's data abilities rather than
  // plotting them yourself
  // Add some paths todo
  // todo: change so centered on page or nice to zoom around etc

  function setSky() {
    setLabel("Stars in Sky (February)")

    svg.append('rect')    // blue
            .attr('x', 0)
            .attr('y', 0)
            .attr('width', 900)
            .attr('height', 1000)
            .attr('fill', '#002868');

    let dataStr = "105,567 177,448 199,703 211,362 217,656 " +
            "235,723 237,395 239,523 269,328 275,700 " +
            "285,514 296,848 305,794 315,706 335,269 " +
            "339,876 372,703 377,504 380,132 417,48 " +
            "420,318 424,471 431,622 432,860 44,402 " +
            "475,432 489,696 501,224 515,782 533,704 " +
            "541,244 549,802 556,378 568,291 571,334 " +
            "571,568 581,580 593,514 601,708 612,190 " +
            "621,759 640,144 648,211 67,360 679,187 " +
            "684,758 685,227 697,362 728,412 733,290 " +
            "837,298 865,366 865,378 "

    let data = []
    let prev = 0
    for (i = 0; i < 50; i++) {
      let next = dataStr.indexOf(" ", prev)
      let vals = dataStr.substring(prev, next)
      let comma = vals.indexOf(",")
      let temp = []
      temp.push(vals.substring(0,comma))
      temp.push(vals.substring(comma+1))
      data.push(temp)
      prev = next + 1
    }

    // alerts are handy, as are text on the screen (handier than the console?)

    // svg.append('polygon')
    //   .attr('points', arrToPoints(moveStarTo([...STAR], 50, 100)))
    //   .style('fill', 'white')

    svg.selectAll('polygon')
            .data(data)
            .enter()
            .append('polygon')
            .attr('points', function(d) {
              return arrToPoints(moveStarTo([...STAR],
              parseInt(d[0]), parseInt(d[1])))
            })
            .style('fill', 'white')

    // todo
  }

  function moveStarTo(arr, x, y) {
    for (xpt = 0; xpt < 9; xpt += 2) {
      arr[xpt] += x;
      arr[xpt] = Math.round(arr[xpt])
      arr[xpt+1] += y;
      arr[xpt+1] = Math.round(arr[xpt+1])
    }
    return arr
  }

</script>

